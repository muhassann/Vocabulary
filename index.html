<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .word-card {
            transition: transform 0.2s;
        }
        .word-card:hover {
            transform: translateY(-3px);
        }
        #app {
            max-width: 500px;
            margin: 0 auto;
        }
        body {
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .card-flip {
            perspective: 1000px;
        }
        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .card-front {
            z-index: 2;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .definition-text {
            white-space: pre-line;
        }
        .app-button {
            width: 100%;
            height: 3rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="p-4">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-700">The App</h1>
            <div class="relative">
                <button id="menu-button" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div id="menu-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden">
                    <a href="#" id="word-list-option" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Word List</a>
                    <a href="#" id="export-option" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Export Words</a>
                    <a href="#" id="import-option" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Import Words</a>
                </div>
            </div>
        </header>

        <div id="views">
            <!-- List View -->
            <div id="list-view" class="view">
                <!-- Main Add Word button - triple width, triple height -->
                <div class="flex justify-center mb-10">
                     <button id="add-button" style="width: 60vw;" class="bg-green-500 hover:bg-green-600 text-white py-8 text-xl font-bold rounded-lg shadow-md">
                        Add Word
                      </button>
                </div>

		<div class="flex justify-center mb-6">
    			<button id="study-button" style="width: 1200px;" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-8 text-xl font-bold rounded-lg shadow-md">
        			Study Mode
    			</button>
		</div>

                <!-- Word list is hidden by default -->
                <div id="word-list" class="space-y-3 hidden">
                    <!-- Words will be displayed here -->
                </div>
                
                <!-- Small counter instead of welcome box -->
                <div class="text-center text-sm text-gray-500 mt-4">
                    <p>Words saved: <span id="word-count">0</span></p>
                </div>
            </div>

            <!-- Word List View (separate from main view) -->
            <div id="word-list-view" class="view hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Word List</h2>
                    <button id="back-from-list-button" class="text-gray-400 hover:text-gray-600">
                        ← Back
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="list-search-input" placeholder="Search words..." 
                           class="w-full p-2 border rounded focus:outline-none focus:ring focus:border-blue-300">
                </div>
                
                <div id="word-list-container" class="space-y-3">
                    <!-- Words will be displayed here in the separate list view -->
                </div>
            </div>

            <!-- Add Word View -->
            <div id="add-view" class="view hidden bg-white p-4 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Add New Word</h2>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">English Word</label>
                        <div class="flex">
                            <input type="text" id="english-input" class="mt-1 block w-full p-2 border rounded-l focus:outline-none focus:ring focus:border-blue-300">
                            <button id="lookup-english-button" class="mt-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-r">
                                Lookup
                            </button>
                        </div>
                        <div id="lookup-status" class="text-sm text-gray-500 mt-1 hidden">Looking up word...</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Korean Translation</label>
                        <div class="flex">
                            <input type="text" id="korean-input" class="mt-1 block w-full p-2 border rounded-l focus:outline-none focus:ring focus:border-blue-300">
                            <button id="lookup-korean-button" class="mt-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-r">
                                Translate
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Definition</label>
                        <textarea id="definition-input" class="mt-1 block w-full p-2 border rounded focus:outline-none focus:ring focus:border-blue-300" rows="12"></textarea>
                    </div>
                    
                    <div class="flex space-x-2 pt-2">
                        <button id="cancel-add-button" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded flex-1">
                            Cancel
                        </button>
                        <button id="save-button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex-1">
                            Save
                        </button>
                    </div>
                </div>
            </div>

            <!-- Word Detail View -->
            <div id="detail-view" class="view hidden bg-white p-4 rounded shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="detail-english" class="text-xl font-bold">Word</h2>
                    <button id="back-button" class="text-gray-400 hover:text-gray-600">
                        ← Back
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <span id="detail-korean" class="text-lg font-medium">한국어</span>
                    </div>
                    
                    <div>
                        <h3 class="text-sm font-medium text-gray-700">Definition:</h3>
                        <p id="detail-definition" class="definition-text">Definition goes here</p>
                    </div>
                    
                    <div class="text-right pt-4">
                        <button id="edit-button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mr-2">
                            Edit
                        </button>
                        <button id="delete-button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            Delete
                        </button>
                    </div>
                </div>
            </div>

            <!-- Study Mode View -->
            <div id="study-view" class="view hidden">
                <div class="bg-white p-4 rounded shadow mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Study Mode</h2>
                        <button id="exit-study-button" class="text-gray-400 hover:text-gray-600">
                            ← Exit
                        </button>
                    </div>
                    
                    <div class="text-center py-4">
                        <div id="flashcard" class="border-2 border-indigo-200 rounded-lg p-6 cursor-pointer">
                            <div id="card-front" class="text-2xl font-bold">Click to start</div>
                            <div id="card-back" class="hidden">
                                <div id="study-korean" class="text-xl mb-2"></div>
                                <div id="study-definition" class="text-sm mb-2 definition-text"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex justify-center space-x-4">
                            <button id="prev-card" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded disabled:opacity-50">
                                Previous
                            </button>
                            <button id="next-card" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded disabled:opacity-50">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import functionality -->
    <input type="file" id="file-input" class="hidden" accept=".json">

    <script>
        // WordsAPI Key
        const WORDS_API_KEY = "728032bd06msh52c0428ce9e3d15p1cd770jsn58b38971cf67";
        
        // Main app logic
        document.addEventListener('DOMContentLoaded', function() {
            // State management
            let words = JSON.parse(localStorage.getItem('vocabularyWords') || '[]');
            let currentView = 'list';
            let currentWordId = null;
            let studyIndex = 0;
            let studyWords = [];
            let isEditing = false;

            // Local dictionary data - a small sample for common words
            const localDictionary = {
                "hello": {
                    definition: "Used as a greeting or to begin a phone conversation.",
                    korean: "안녕하세요",
                    examples: ["Hello, how are you today?", "I said hello but she didn't hear me."]
                },
                "thank": {
                    definition: "Express gratitude to (someone).",
                    korean: "감사하다",
                    examples: ["I thanked him for his help.", "Thank you for your assistance."]
                },
                "please": {
                    definition: "Used as a polite request or to add emphasis.",
                    korean: "제발",
                    examples: ["Please help me with this.", "Come in, please."]
                },
                "sorry": {
                    definition: "Feeling regret or penitence.",
                    korean: "미안합니다",
                    examples: ["I'm sorry for the mistake.", "Sorry, I can't attend your party."]
                },
                "good": {
                    definition: "To be desired or approved of; having the required qualities.",
                    korean: "좋은",
                    examples: ["The food was very good.", "She's a good teacher."]
                }
            };

            // DOM elements - views
            const listView = document.getElementById('list-view');
            const wordListView = document.getElementById('word-list-view');
            const addView = document.getElementById('add-view');
            const detailView = document.getElementById('detail-view');
            const studyView = document.getElementById('study-view');

            // DOM elements - list view
            const wordList = document.getElementById('word-list');
            const wordListContainer = document.getElementById('word-list-container');
            const listSearchInput = document.getElementById('list-search-input');
            const addButton = document.getElementById('add-button');
            const studyButton = document.getElementById('study-button');
            const wordCount = document.getElementById('word-count');

            // DOM elements - menu
            const menuButton = document.getElementById('menu-button');
            const menuDropdown = document.getElementById('menu-dropdown');
            const wordListOption = document.getElementById('word-list-option');
            const exportOption = document.getElementById('export-option');
            const importOption = document.getElementById('import-option');
            const backFromListButton = document.getElementById('back-from-list-button');

            // DOM elements - add view
            const englishInput = document.getElementById('english-input');
            const koreanInput = document.getElementById('korean-input');
            const definitionInput = document.getElementById('definition-input');
            const saveButton = document.getElementById('save-button');
            const cancelAddButton = document.getElementById('cancel-add-button');
            const lookupEnglishButton = document.getElementById('lookup-english-button');
            const lookupKoreanButton = document.getElementById('lookup-korean-button');
            const lookupStatus = document.getElementById('lookup-status');

            // DOM elements - detail view
            const detailEnglish = document.getElementById('detail-english');
            const detailKorean = document.getElementById('detail-korean');
            const detailDefinition = document.getElementById('detail-definition');
            const backButton = document.getElementById('back-button');
            const editButton = document.getElementById('edit-button');
            const deleteButton = document.getElementById('delete-button');

            // DOM elements - study view
            const flashcard = document.getElementById('flashcard');
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');
            const studyKorean = document.getElementById('study-korean');
            const studyDefinition = document.getElementById('study-definition');
            const prevCardButton = document.getElementById('prev-card');
            const nextCardButton = document.getElementById('next-card');
            const exitStudyButton = document.getElementById('exit-study-button');

            // DOM elements - export/import
            const fileInput = document.getElementById('file-input');

            // Initialize the app
            initialize();

            // Event listeners
            addButton.addEventListener('click', showAddView);
            cancelAddButton.addEventListener('click', showListView);
            saveButton.addEventListener('click', saveWord);
            backButton.addEventListener('click', showListView);
            backFromListButton.addEventListener('click', showListView);
            deleteButton.addEventListener('click', deleteCurrentWord);
            listSearchInput.addEventListener('input', () => renderWordListContainer(listSearchInput.value));
            studyButton.addEventListener('click', startStudyMode);
            flashcard.addEventListener('click', flipCard);
            prevCardButton.addEventListener('click', () => moveCard(-1));
            nextCardButton.addEventListener('click', () => moveCard(1));
            exitStudyButton.addEventListener('click', showListView);
            lookupEnglishButton.addEventListener('click', lookupEnglishWord);
            lookupKoreanButton.addEventListener('click', lookupKoreanTranslation);
            editButton.addEventListener('click', editCurrentWord);
            
            // Menu event listeners
            menuButton.addEventListener('click', toggleMenu);
            wordListOption.addEventListener('click', showWordListView);
            exportOption.addEventListener('click', exportWords);
            importOption.addEventListener('click', () => {
                hideMenu();
                fileInput.click();
            });
            fileInput.addEventListener('change', importWords);
            
            // Click outside to close menu
            document.addEventListener('click', function(event) {
                if (!menuButton.contains(event.target) && !menuDropdown.contains(event.target)) {
                    hideMenu();
                }
            });
            
            // Functions
            function initialize() {
                // Add sample words if none exist
                if (words.length === 0) {
                    words = [
                        {
                            id: 1,
                            english: 'appreciate',
                            korean: '감사하다',
                            definition: 'Definition 1: to recognize the full worth of something\nSynonym: value, acknowledge\nExample: I appreciate your help\n\nDefinition 2: to increase in value\nSynonym: grow, rise\nExample: The property has appreciated over time',
                            dateAdded: new Date().toISOString()
                        },
                        {
                            id: 2,
                            english: 'refrigerator',
                            korean: '냉장고',
                            definition: 'Definition 1: an appliance for keeping food cold\nSynonym: fridge, cooler\nExample: The milk is in the refrigerator',
                            dateAdded: new Date().toISOString()
                        }
                    ];
                    saveWordsToStorage();
                }

                // Update word count
                updateWordCount();
                
                // Render the word list (hidden)
                renderWordList();
                
                // Start at list view
                showView('list');
            }
            
            function updateWordCount() {
                wordCount.textContent = words.length;
            }
            
            function toggleMenu() {
                menuDropdown.classList.toggle('hidden');
            }
            
            function hideMenu() {
                menuDropdown.classList.add('hidden');
            }

            function showView(viewName) {
                currentView = viewName;
                
                // Hide all views
                listView.classList.add('hidden');
                wordListView.classList.add('hidden');
                addView.classList.add('hidden');
                detailView.classList.add('hidden');
                studyView.classList.add('hidden');
                
                // Show selected view
                if (viewName === 'list') {
                    listView.classList.remove('hidden');
                } else if (viewName === 'wordList') {
                    wordListView.classList.remove('hidden');
                } else if (viewName === 'add') {
                    addView.classList.remove('hidden');
                } else if (viewName === 'detail') {
                    detailView.classList.remove('hidden');
                } else if (viewName === 'study') {
                    studyView.classList.remove('hidden');
                }
            }

            function showListView() {
                isEditing = false;
                showView('list');
                hideMenu();
                updateWordCount();
            }
            
            function showWordListView(e) {
                if (e) e.preventDefault();
                renderWordListContainer();
                showView('wordList');
                hideMenu();
            }

            function showAddView() {
                isEditing = false;
                currentWordId = null;
                englishInput.value = '';
                koreanInput.value = '';
                definitionInput.value = '';
                
                showView('add');
                englishInput.focus();
            }

            function showDetailView(wordId) {
                currentWordId = wordId;
                const word = words.find(w => w.id === wordId);
                
                if (word) {
                    detailEnglish.textContent = word.english;
                    detailKorean.textContent = word.korean;
                    detailDefinition.textContent = word.definition || 'No definition available';
                }
                
                showView('detail');
            }
            
            function editCurrentWord() {
                const word = words.find(w => w.id === currentWordId);
                if (!word) return;
                
                isEditing = true;
                currentWordId = word.id;
                
                englishInput.value = word.english;
                koreanInput.value = word.korean;
                definitionInput.value = word.definition || '';
                
                showView('add');
            }

            function exportWords() {
                // Get words from localStorage
                const words = JSON.parse(localStorage.getItem('vocabularyWords') || '[]');
                
                if (words.length === 0) {
                    alert('No words to export!');
                    return;
                }
                
                // Create a JSON string with formatting for readability
                const wordsJson = JSON.stringify(words, null, 2);
                
                // Create a Blob with the JSON data
                const blob = new Blob([wordsJson], { type: 'application/json' });
                
                // Create a download URL for the Blob
                const url = URL.createObjectURL(blob);
                
                // Create a temporary anchor element to trigger the download
                const a = document.createElement('a');
                a.href = url;
                
                // Generate a filename with date
                const date = new Date();
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                a.download = `vocabulary-words-${dateStr}.json`;
                
                // Append to the document, click to download, then remove
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                hideMenu();
                
                // Show a confirmation
                alert(`Exported ${words.length} vocabulary words successfully!`);
            }

            function importWords(event) {
                const file = event.target.files[0];
                
                if (!file) {
                    return; // No file selected
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        // Parse the file content as JSON
                        const importedWords = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedWords)) {
                            throw new Error('Invalid format: imported data is not an array');
                        }
                        
                        // Validate the structure of each word
                        const validWords = importedWords.filter(word => {
                            return word && 
                                   typeof word === 'object' && 
                                   word.id && 
                                   word.english && 
                                   typeof word.english === 'string';
                        });
                        
                        if (validWords.length === 0) {
                            throw new Error('No valid vocabulary words found in the file');
                        }
                        
                        // Confirm import
                        const confirmMessage = `Found ${validWords.length} words to import. This will replace your current words. Continue?`;
                        if (confirm(confirmMessage)) {
                            // Save to localStorage
                            localStorage.setItem('vocabularyWords', JSON.stringify(validWords));
                            
                            // Reload words and update the UI
                            words = validWords;
                            renderWordList();
                            updateWordCount();
                            
                            alert(`Successfully imported ${validWords.length} vocabulary words!`);
                        }
                    } catch (error) {
                        alert(`Error importing words: ${error.message}`);
                        console.error('Import error:', error);
                    }
                    
                    // Reset the file input
                    fileInput.value = '';
                };
                
                reader.onerror = function() {
                    alert('Error reading the file');
                    // Reset the file input
                    fileInput.value = '';
                };
                
                // Read the file as text
                reader.readAsText(file);
            }

            function saveWord() {
                const english = englishInput.value.trim();
                const korean = koreanInput.value.trim();
                const definition = definitionInput.value.trim();
                
                if (!english) {
                    alert('English word is required!');
                    return;
                }
                
                // Check if word already exists
                const existingWordIndex = words.findIndex(word => 
                    word.english.toLowerCase() === english.toLowerCase() && 
                    (!isEditing || word.id !== currentWordId)
                );
                
                if (existingWordIndex !== -1) {
                    const existingWord = words[existingWordIndex];
                    const confirmMessage = `The word "${english}" already exists in your vocabulary. Do you want to update it?`;
                    
                    if (confirm(confirmMessage)) {
                        // Update the existing word
                        words[existingWordIndex] = {
                            ...existingWord,
                            korean,
                            definition,
                            dateAdded: new Date().toISOString() // Update date
                        };
                        
                        saveWordsToStorage();
                        showListView();
                        updateWordCount();
                        return;
                    } else {
                        // User canceled, stay on add view
                        return;
                    }
                }
                
                if (isEditing) {
                    // Update existing word
                    const index = words.findIndex(w => w.id === currentWordId);
                    if (index !== -1) {
                        words[index] = {
                            ...words[index],
                            english,
                            korean,
                            definition,
                            dateAdded: words[index].dateAdded
                        };
                    }
                } else {
                    // Add new word
                    const newWord = {
                        id: Date.now(),
                        english,
                        korean,
                        definition,
                        dateAdded: new Date().toISOString()
                    };
                    
                    words.push(newWord);
                }
                
                saveWordsToStorage();
                showListView();
                updateWordCount();
            }

            function deleteCurrentWord() {
                if (confirm('Are you sure you want to delete this word?')) {
                    words = words.filter(w => w.id !== currentWordId);
                    saveWordsToStorage();
                    showListView();
                    updateWordCount();
                }
            }

            function saveWordsToStorage() {
                localStorage.setItem('vocabularyWords', JSON.stringify(words));
            }

            function renderWordList() {
                // This function still exists but since the list is hidden, it doesn't need to do much
                // We'll keep it for backward compatibility
                wordList.innerHTML = '';
            }
            
            function renderWordListContainer(searchTermParam) {
                const searchTerm = (searchTermParam || listSearchInput.value || '').toLowerCase();
                
                // Filter words based on search term
                const filteredWords = words.filter(word => {
                    return word.english.toLowerCase().includes(searchTerm) ||
                           (word.korean && word.korean.includes(searchTerm)) ||
                           (word.definition && word.definition.toLowerCase().includes(searchTerm));
                });
                
                // Sort by most recently added
                filteredWords.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                
                // Clear the list
                wordListContainer.innerHTML = '';
                
                // Add word cards
                if (filteredWords.length > 0) {
                    filteredWords.forEach(word => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-3 rounded shadow word-card cursor-pointer';
                        card.addEventListener('click', () => showDetailView(word.id));
                        
                        // Extract first definition line for display
                        let shortDefinition = word.definition || '';
                        const defMatch = shortDefinition.match(/Definition 1: ([^\n]+)/);
                        if (defMatch && defMatch[1]) {
                            shortDefinition = defMatch[1];
                        } else {
                            // If no match, just take the first line or part of it
                            shortDefinition = shortDefinition.split('\n')[0];
                            if (shortDefinition.length > 60) {
                                shortDefinition = shortDefinition.substring(0, 57) + '...';
                            }
                        }
                        
                        card.innerHTML = `
                            <div class="flex justify-between">
                                <h2 class="font-bold">${word.english}</h2>
                                <span class="text-gray-600">${word.korean || ''}</span>
                            </div>
                            <p class="text-sm text-gray-600 truncate">${shortDefinition}</p>
                        `;
                        
                        wordListContainer.appendChild(card);
                    });
                } else {
                    // Show empty state
                    const emptyState = document.createElement('div');
                    emptyState.className = 'text-center text-gray-500 py-8';
                    emptyState.textContent = 'No words found. Add some vocabulary!';
                    wordListContainer.appendChild(emptyState);
                }
            }

            function startStudyMode() {
                // Use all words for study
                studyWords = [...words];
                
                // Shuffle the words for study
                studyWords.sort(() => Math.random() - 0.5);
                
                // Reset study index
                studyIndex = 0;
                
                // Update the UI
                updateStudyCard();
                
                // Show study view
                showView('study');
            }

            function updateStudyCard() {
                if (studyWords.length === 0) {
                    cardFront.textContent = "No words to study";
                    prevCardButton.disabled = true;
                    nextCardButton.disabled = true;
                    return;
                }
                
                const word = studyWords[studyIndex];
                cardFront.textContent = word.english;
                studyKorean.textContent = word.korean || '(No translation)';
                studyDefinition.textContent = word.definition || 'No definition available';
                
                // Reset card to front
                cardBack.classList.add('hidden');
                
                // Update buttons
                prevCardButton.disabled = studyIndex === 0;
                nextCardButton.disabled = studyIndex === studyWords.length - 1;
            }

            function flipCard() {
                if (studyWords.length === 0) return;
                cardBack.classList.toggle('hidden');
            }

            function moveCard(direction) {
                if (studyWords.length === 0) return;
                
                studyIndex = Math.max(0, Math.min(studyIndex + direction, studyWords.length - 1));
                updateStudyCard();
            }

            // Dictionary lookup functions
            async function lookupEnglishWord() {
                const word = englishInput.value.trim().toLowerCase();
                if (!word) return;
                
                // Show status
                lookupStatus.textContent = 'Looking up word...';
                lookupStatus.classList.remove('hidden');
                lookupStatus.classList.remove('text-red-500');
                lookupStatus.classList.add('text-gray-500');
                
                try {
                    // WordsAPI request
                    const response = await fetch(`https://wordsapiv1.p.rapidapi.com/words/${encodeURIComponent(word)}`, {
                        method: 'GET',
                        headers: {
                            'X-RapidAPI-Key': WORDS_API_KEY,
                            'X-RapidAPI-Host': 'wordsapiv1.p.rapidapi.com'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('API request failed');
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.results && data.results.length > 0) {
                        // Format definitions with their synonyms and examples
                        let formattedDefinitions = [];
                        
                        // Process up to the first 2 definitions
                        const definitionsToProcess = data.results.slice(0, 2);
                        
                        definitionsToProcess.forEach((result, index) => {
                            // Format definition with exact line breaks as requested
                            let formattedDef = `Definition ${index + 1}: ${result.definition}`;
                            
                            // Add synonyms
                            formattedDef += `\nSynonym: `;
                            if (result.synonyms && result.synonyms.length > 0) {
                                formattedDef += result.synonyms.slice(0, 3).join(', ');
                            } else {
                                formattedDef += '(none available)';
                            }
                            
                            // Add examples
                            formattedDef += `\nExample: `;
                            if (result.examples && result.examples.length > 0) {
                                formattedDef += result.examples[0];
                            } else {
                                formattedDef += '(none available)';
                            }
                            
                            // Add to collection
                            formattedDefinitions.push(formattedDef);
                        });
                        
                        // Set the combined definitions in the definition input with double line break between definitions
                        definitionInput.value = formattedDefinitions.join('\n\n');
                        
                        // Success message
                        lookupStatus.textContent = 'Definition found!';
                        lookupStatus.classList.remove('text-gray-500');
                        lookupStatus.classList.add('text-green-500');
                        
                        // Try to get Korean translation
                        lookupKoreanTranslation();
                    } else {
                        throw new Error('No definition found');
                    }
                } catch (error) {
                    console.error('WordsAPI lookup error:', error);
                    
                    // Try fallback to free Dictionary API
                    try {
                        const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data && data.length > 0) {
                                const entry = data[0];
                                
                                if (entry.meanings && entry.meanings.length > 0) {
                                    const formattedDefinitions = [];
                                    
                                    // Process up to 2 meanings/definitions
                                    const meaningsToProcess = entry.meanings.slice(0, 2);
                                    
                                    meaningsToProcess.forEach((meaning, meaningIndex) => {
                                        if (meaning.definitions && meaning.definitions.length > 0) {
                                            const def = meaning.definitions[0];
                                            
                                            // Format definition with exact line breaks as requested
                                            let formattedDef = `Definition ${meaningIndex + 1}: ${def.definition}`;
                                            if (meaning.partOfSpeech) {
                                                formattedDef += ` (${meaning.partOfSpeech})`;
                                            }
                                            
                                            // Add synonyms
                                            formattedDef += `\nSynonym: `;
                                            if (meaning.synonyms && meaning.synonyms.length > 0) {
                                                formattedDef += meaning.synonyms.slice(0, 3).join(', ');
                                            } else {
                                                formattedDef += '(none available)';
                                            }
                                            
                                            // Add examples
                                            formattedDef += `\nExample: `;
                                            if (def.example) {
                                                formattedDef += def.example;
                                            } else {
                                                formattedDef += '(none available)';
                                            }
                                            
                                            formattedDefinitions.push(formattedDef);
                                        }
                                    });
                                    
                                    // Set formatted definitions with double line break between definitions
                                    definitionInput.value = formattedDefinitions.join('\n\n');
                                }
                                
                                lookupStatus.textContent = 'Definition found (backup source)!';
                                lookupStatus.classList.remove('text-gray-500');
                                lookupStatus.classList.add('text-green-500');
                                
                                lookupKoreanTranslation();
                                return;
                            }
                        }
                        
                        // If both APIs fail, check local dictionary
                        if (localDictionary[word]) {
                            const entry = localDictionary[word];
                            
                            // Format with exact line breaks as requested
                            let formattedDef = `Definition 1: ${entry.definition}`;
                            formattedDef += `\nSynonym: (none available)`;
                            
                            if (entry.examples && entry.examples.length > 0) {
                                formattedDef += `\nExample: ${entry.examples[0]}`;
                            } else {
                                formattedDef += `\nExample: (none available)`;
                            }
                            
                            definitionInput.value = formattedDef;
                            
                            if (entry.korean) {
                                koreanInput.value = entry.korean;
                            }
                            
                            lookupStatus.textContent = 'Definition found in local dictionary!';
                            lookupStatus.classList.remove('text-gray-500');
                            lookupStatus.classList.add('text-green-500');
                        } else {
                            lookupStatus.textContent = 'Definition not found.';
                            lookupStatus.classList.remove('text-gray-500');
                            lookupStatus.classList.add('text-red-500');
                            generateSampleDefinition(word);
                        }
                    } catch (fallbackError) {
                        console.error('Fallback lookup error:', fallbackError);
                        lookupStatus.textContent = 'Definition not found.';
                        lookupStatus.classList.remove('text-gray-500');
                        lookupStatus.classList.add('text-red-500');
                        
                        // Try local dictionary or generate sample
                        if (localDictionary[word]) {
                            const entry = localDictionary[word];
                            
                            // Format with exact line breaks as requested
                            let formattedDef = `Definition 1: ${entry.definition}`;
                            formattedDef += `\nSynonym: (none available)`;
                            
                            if (entry.examples && entry.examples.length > 0) {
                                formattedDef += `\nExample: ${entry.examples[0]}`;
                            } else {
                                formattedDef += `\nExample: (none available)`;
                            }
                            
                            definitionInput.value = formattedDef;
                            
                            if (entry.korean) {
                                koreanInput.value = entry.korean;
                            }
                        } else {
                            generateSampleDefinition(word);
                        }
                    }
                } finally {
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        lookupStatus.classList.add('hidden');
                    }, 3000);
                }
            }
            
            function lookupKoreanTranslation() {
                const word = englishInput.value.trim().toLowerCase();
                if (!word) return;
                
                // Check local dictionary first
                if (localDictionary[word] && localDictionary[word].korean) {
                    koreanInput.value = localDictionary[word].korean;
                    return;
                }
                
                // Try the translation API (may not work locally due to CORS)
                try {
                    fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|ko`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Translation failed');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.responseData && data.responseData.translatedText) {
                                koreanInput.value = data.responseData.translatedText;
                            } else {
                                throw new Error('No translation found');
                            }
                        })
                        .catch(error => {
                            console.error('Translation lookup error:', error);
                            // No visual error shown to user, since this is supplementary
                            generateSampleTranslation(word);
                        });
                } catch (error) {
                    console.error('Translation API request error:', error);
                    // Generate sample translation for demonstration
                    generateSampleTranslation(word);
                }
            }
            
            // Helper functions to generate sample content when APIs aren't available
            function generateSampleDefinition(word) {
                const definitions = {
                    noun: [
                        "a physical object or item",
                        "a person, place, or thing",
                        "a concept or idea represented by a word",
                        "a type of activity or action"
                    ],
                    verb: [
                        "to perform an action",
                        "to engage in a specific activity",
                        "to cause something to happen",
                        "to change from one state to another"
                    ],
                    adjective: [
                        "describing a quality or characteristic",
                        "indicating a state or condition",
                        "expressing a property of something",
                        "modifying a noun to provide more information"
                    ]
                };
                
                // Simple approach: longer words more likely to be nouns
                let type1 = word.length > 8 ? 'noun' : (word.length > 5 ? 'verb' : 'adjective');
                
                // Pick a different type for second definition
                const types = ['noun', 'verb', 'adjective'];
                const typeIndex = types.indexOf(type1);
                const remainingTypes = types.filter((_, i) => i !== typeIndex);
                const type2 = remainingTypes[Math.floor(Math.random() * remainingTypes.length)];
                
                // Select random definitions from the appropriate types
                const defOptions1 = definitions[type1];
                const definition1 = defOptions1[Math.floor(Math.random() * defOptions1.length)];
                
                const defOptions2 = definitions[type2];
                const definition2 = defOptions2[Math.floor(Math.random() * defOptions2.length)];
                
                // Generate some sample synonyms
                const generateSynonyms = (type) => {
                    const synonymSets = {
                        noun: ['item', 'object', 'thing', 'entity', 'element'],
                        verb: ['act', 'perform', 'execute', 'do', 'conduct'],
                        adjective: ['descriptive', 'qualifying', 'modifying', 'characterizing']
                    };
                    const syns = synonymSets[type];
                    // Pick 2 random synonyms
                    const shuffled = [...syns].sort(() => 0.5 - Math.random());
                    return shuffled.slice(0, 2).join(', ');
                };
                
                // Generate example sentences
                const templates = [
                    `The ${word} was particularly useful in this situation.`,
                    `I need to ${word} before the deadline.`,
                    `She couldn't understand the ${word} properly.`,
                    `They decided to ${word} together.`
                ];
                
                // Format with exact line breaks as requested
                const formatted1 = `Definition 1: ${definition1}\nSynonym: ${generateSynonyms(type1)}\nExample: ${templates[0]}`;
                const formatted2 = `Definition 2: ${definition2}\nSynonym: ${generateSynonyms(type2)}\nExample: ${templates[2]}`;
                
                // Set the definitions in the input with double line break between definitions
                definitionInput.value = `${formatted1}\n\n${formatted2}`;
            }
            
            function generateSampleTranslation(word) {
                // For demonstration only - this is not an actual translation
                // In a real app, you would use an actual translation API
                const mockKoreanChars = [
                    '가', '나', '다', '라', '마', '바', '사', '아', '자', '차', '카', '타', '파', '하',
                    '강', '경', '구', '기', '대', '도', '로', '머', '미', '버', '서', '소', '시', '에', '우', '응'
                ];
                
                // Simple generation based on word length
                let koreanWord = '';
                for (let i = 0; i < Math.min(word.length, 4); i++) {
                    koreanWord += mockKoreanChars[Math.floor(Math.random() * mockKoreanChars.length)];
                }
                
                koreanInput.value = koreanWord;
            }
        });
    </script>
</body>
</html>
